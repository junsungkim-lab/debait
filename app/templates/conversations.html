{% extends "base.html" %}
{% block content %}

<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
  <div>
    <h1 style="font-size: 20px; font-weight: 800; color: #0f172a;">ëŒ€í™” ê¸°ë¡</h1>
    <p class="text-muted mt-2">ì›¹ Â· Telegram ëª¨ë“  ëŒ€í™”ê°€ ì €ì¥ë©ë‹ˆë‹¤.</p>
  </div>
  <a href="/" class="btn btn-primary" style="text-decoration: none;">ìƒˆ ì§ˆë¬¸ â†’</a>
</div>

{% if not threads %}
  <div class="card" style="text-align: center; padding: 48px 24px; color: #94a3b8;">
    <div style="font-size: 40px; margin-bottom: 12px;">ğŸ’¬</div>
    <div style="font-weight: 600; color: #64748b;">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    <div class="text-muted mt-2">Chat íƒ­ì—ì„œ ì²« ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”.</div>
  </div>
{% endif %}

{% set stage_colors = [
  ('#eff6ff', '#3b82f6', '#2563eb'),
  ('#fff7ed', '#f97316', '#ea580c'),
  ('#fdf4ff', '#a855f7', '#9333ea'),
  ('#f0fdfa', '#14b8a6', '#0f766e'),
  ('#fff1f2', '#f43f5e', '#be123c'),
  ('#fffbeb', '#f59e0b', '#b45309'),
] %}

{% for t in threads %}
  {% set user_msg = t.messages | selectattr('role', 'equalto', 'user') | first %}
  {% set final_msg = t.messages | selectattr('role', 'equalto', 'assistant') | first %}
  {% set stage_msgs = t.messages | selectattr('role', 'ne', 'user') | selectattr('role', 'ne', 'assistant') | list %}
  {% set is_multi = stage_msgs | length > 0 %}
  {% set is_telegram = t.thread_key.startswith('telegram:') %}

  <div class="card">
    <!-- Header -->
    <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
      <div style="flex: 1;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
          <span style="font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 99px;
            background: {{ '#e0f2fe' if is_telegram else '#ede9fe' }};
            color: {{ '#0369a1' if is_telegram else '#6d28d9' }};">
            {{ 'Telegram' if is_telegram else 'Web' }}
          </span>
          {% if is_multi %}
            <span style="font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 99px; background: #fef3c7; color: #92400e;">
              ì „ì²´ í† ë¡ 
            </span>
          {% else %}
            <span style="font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 99px; background: #f1f5f9; color: #475569;">
              ë‹¨ìˆœ ë‹µë³€
            </span>
          {% endif %}
        </div>
        {% if user_msg %}
          <div style="font-size: 15px; font-weight: 600; color: #0f172a; line-height: 1.4;">
            {{ user_msg.content | truncate(120) }}
          </div>
        {% endif %}
      </div>
      <div class="text-muted" style="white-space: nowrap; font-size: 12px;">
        {{ t.updated_at.strftime('%m/%d %H:%M') if t.updated_at else '' }}
      </div>
    </div>

    <!-- Debate stages (collapsible if multi) -->
    {% if is_multi %}
      <details>
        <summary style="font-size: 13px; color: #6366f1; font-weight: 600; padding: 8px 0; margin-bottom: 8px;">
          í† ë¡  ê³¼ì • ë³´ê¸° ({{ stage_msgs | map(attribute='role') | join(' Â· ') }})
        </summary>
        {% for msg in stage_msgs %}
          {% set ci = loop.index0 % stage_colors|length %}
          {% set bg, border, label_color = stage_colors[ci] %}
          <div class="stage {% if loop.first %}mt-3{% endif %}" style="background: {{ bg }}; border-left: 4px solid {{ border }};">
            <div class="stage-label" style="color: {{ label_color }};">{{ msg.role }}</div>
            <div class="stage-content">{{ msg.content }}</div>
          </div>
        {% endfor %}
      </details>
    {% endif %}

    <!-- Final answer -->
    {% if final_msg %}
      <div class="stage stage-final" style="margin-bottom: 0;">
        <div class="stage-label">ìµœì¢… ë‹µë³€</div>
        <div class="stage-content">{{ final_msg.content }}</div>
      </div>
    {% endif %}
  </div>
{% endfor %}

{% endblock %}
