{% extends "base.html" %}
{% block content %}

<!-- Hero / Ask -->
<div class="card" style="padding: 32px;">
  <div style="margin-bottom: 24px;">
    <h1 style="font-size: 24px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px;">
      AI 집단지성에게 물어보세요
    </h1>
    <p class="text-muted mt-2">
      여러 AI가 파이프라인 순서로 토론해 최적의 답을 만듭니다.
    </p>
  </div>

  {% if not keys %}
    <div style="background: #fef9c3; border: 1px solid #fde047; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; font-size: 14px; color: #713f12;">
      API Key가 등록되지 않았습니다.
      <a href="/settings" style="color: #7c3aed; font-weight: 600;">Settings에서 등록</a>하고 시작하세요.
    </div>
  {% endif %}

  <form method="post" action="/ask" id="ask-form">
    <textarea
      name="question"
      id="question"
      rows="4"
      placeholder="질문을 입력하세요. 예) 스타트업 초기에 TypeScript를 도입해야 할까요?"
      style="resize: vertical; margin-bottom: 12px;"
      required
    >{{ question or "" }}</textarea>
    <button type="submit" class="btn btn-primary" id="ask-btn" {% if not keys %}disabled{% endif %}>
      <span id="btn-text">토론 시작</span>
    </button>
    <span id="loading-msg" style="display:none; margin-left: 12px; font-size: 14px; color: #6366f1;">
      AI들이 토론 중입니다... (10~30초 소요)
    </span>
  </form>
</div>

<!-- Error -->
{% if error %}
  <div class="card" style="border-color: #fca5a5; background: #fff1f2;">
    <div style="font-weight: 700; color: #b91c1c; margin-bottom: 8px;">오류가 발생했습니다</div>
    <div class="mono" style="font-size: 13px; color: #7f1d1d; white-space: pre-wrap;">{{ error }}</div>
    <div class="text-muted mt-3">
      API Key 또는 모델 설정을 확인해보세요. →
      <a href="/settings" style="color: #6366f1; font-weight: 600;">Settings</a>
    </div>
  </div>
{% endif %}

<!-- Result -->
{% if result %}
  <div class="card">
    <div style="margin-bottom: 20px;">
      <div class="text-muted" style="margin-bottom: 6px;">질문</div>
      <div style="font-size: 15px; font-weight: 600; color: #0f172a;">{{ question }}</div>
      {% if result.get('decision') %}
        <span style="display:inline-block; margin-top: 8px; padding: 2px 10px; border-radius: 99px; font-size: 11px; font-weight: 700;
          background: {{ '#dbeafe' if result.decision == 'SIMPLE' else '#ede9fe' }};
          color: {{ '#1d4ed8' if result.decision == 'SIMPLE' else '#6d28d9' }};">
          {{ '단순 질문 (Solver만 사용)' if result.decision == 'SIMPLE' else '복잡한 질문 (전체 토론)' }}
        </span>
      {% endif %}
    </div>

    {% set stage_colors = [
      ('#eff6ff', '#3b82f6', '#2563eb'),
      ('#fff7ed', '#f97316', '#ea580c'),
      ('#fdf4ff', '#a855f7', '#9333ea'),
      ('#f0fdfa', '#14b8a6', '#0f766e'),
      ('#fff1f2', '#f43f5e', '#be123c'),
      ('#fffbeb', '#f59e0b', '#b45309'),
    ] %}
    {% if result.get('stages') and result.get('decision') != 'SIMPLE' %}
      {% for stage in result.stages %}
        {% set ci = loop.index0 % stage_colors|length %}
        {% set bg, border, label_color = stage_colors[ci] %}
        <div class="stage" style="background: {{ bg }}; border-left: 4px solid {{ border }};">
          <div class="stage-label" style="color: {{ label_color }};">{{ stage.name }}</div>
          <div class="stage-content">{{ stage.text }}</div>
        </div>
      {% endfor %}
    {% endif %}

    <div class="stage stage-final" style="{% if result.get('decision') == 'SIMPLE' %}margin-top: 0;{% endif %}">
      <div class="stage-label">최종 답변</div>
      <div class="stage-content">{{ result.final }}</div>
    </div>

    <div style="margin-top: 16px; text-align: right;">
      <a href="/conversations" style="font-size: 13px; color: #6366f1; font-weight: 500;">
        전체 대화 기록 보기 →
      </a>
    </div>
  </div>
{% endif %}

<script>
  document.getElementById('ask-form').addEventListener('submit', function() {
    document.getElementById('btn-text').textContent = '토론 중...';
    document.getElementById('ask-btn').disabled = true;
    document.getElementById('loading-msg').style.display = 'inline';
  });
  // Ctrl+Enter or Cmd+Enter to submit
  document.getElementById('question').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      document.getElementById('ask-form').requestSubmit();
    }
  });
</script>

{% endblock %}
