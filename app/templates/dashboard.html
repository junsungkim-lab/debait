{% extends "base.html" %}
{% block content %}

<!-- Hero / Ask -->
<div class="card" style="padding: 32px;">
  <div style="margin-bottom: 24px;">
    <h1 style="font-size: 24px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px;">
      AI 집단지성에게 물어보세요
    </h1>
    <p class="text-muted mt-2">
      여러 AI가 파이프라인 순서로 토론해 최적의 답을 만듭니다.
    </p>
  </div>

  {% if not keys %}
    <div style="background: #fef9c3; border: 1px solid #fde047; border-radius: 10px; padding: 14px 16px; margin-bottom: 20px; font-size: 14px; color: #713f12;">
      API Key가 등록되지 않았습니다.
      <a href="/settings" style="color: #7c3aed; font-weight: 600;">Settings에서 등록</a>하고 시작하세요.
    </div>
  {% endif %}

  <form method="post" action="/ask" id="ask-form">
    <input type="hidden" name="skip_clarify" value="0" />
    <textarea
      name="question"
      id="question"
      rows="4"
      placeholder="질문을 입력하세요. 예) 스타트업 초기에 TypeScript를 도입해야 할까요?"
      style="resize: vertical; margin-bottom: 12px;"
      required
    >{{ question or "" }}</textarea>
    <button type="submit" class="btn btn-primary" id="ask-btn" {% if not keys %}disabled{% endif %}>
      <span id="btn-text">토론 시작</span>
    </button>
    <span id="loading-msg" style="display:none; margin-left: 12px; font-size: 14px; color: #6366f1;">
      AI들이 토론 중입니다... (10~30초 소요)
    </span>
  </form>
</div>

{% if clarification %}
  <div class="card" style="border-color:#f59e0b; background:#fffbeb;">
    <div style="font-weight: 700; color: #92400e; margin-bottom: 8px;">요청 명확화가 필요합니다</div>
    <div class="text-muted" style="margin-bottom:10px;">
      모호성 점수: <strong>{{ clarification.score }}</strong>
    </div>
    {% if clarification.reasons %}
      <ul style="margin:0 0 12px 18px; color:#78350f; font-size:13px;">
        {% for r in clarification.reasons %}
          <li>{{ r }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post" action="/ask">
      <input type="hidden" name="question" value="{{ question }}" />
      <div style="font-size:13px; font-weight:600; margin-bottom:6px;">확인 질문</div>
      {% for q in clarification.questions %}
        <div class="text-muted" style="font-size:13px; margin-bottom:4px;">- {{ q }}</div>
      {% endfor %}
      <textarea
        name="clarification_context"
        rows="4"
        placeholder="확인 질문에 대한 답을 한 번에 입력하세요."
        style="resize: vertical; margin-top:8px; margin-bottom:10px;"
        required
      ></textarea>
      <div style="display:flex; gap:8px;">
        <button type="submit" class="btn btn-primary">답변 반영 후 실행</button>
        <button type="submit" class="btn btn-secondary" name="skip_clarify" value="1">그대로 실행</button>
      </div>
    </form>
  </div>
{% endif %}

<!-- Error -->
{% if error %}
  <div class="card" style="border-color: #fca5a5; background: #fff1f2;">
    <div style="font-weight: 700; color: #b91c1c; margin-bottom: 8px;">오류가 발생했습니다</div>
    <div class="mono" style="font-size: 13px; color: #7f1d1d; white-space: pre-wrap;">{{ error }}</div>
    <div class="text-muted mt-3">
      API Key 또는 모델 설정을 확인해보세요. →
      <a href="/settings" style="color: #6366f1; font-weight: 600;">Settings</a>
    </div>
  </div>
{% endif %}

<!-- Result -->
{% if result %}
  <div class="card">
    <div style="margin-bottom: 20px;">
      <div class="text-muted" style="margin-bottom: 6px;">질문</div>
      <div style="font-size: 15px; font-weight: 600; color: #0f172a;">{{ question }}</div>
      {% if result.get('decision') %}
        <span style="display:inline-block; margin-top: 8px; padding: 2px 10px; border-radius: 99px; font-size: 11px; font-weight: 700;
          background: {{ '#dbeafe' if result.decision == 'SIMPLE' else '#ede9fe' }};
          color: {{ '#1d4ed8' if result.decision == 'SIMPLE' else '#6d28d9' }};">
          {{ '단순 질문 (Solver만 사용)' if result.decision == 'SIMPLE' else '복잡한 질문 (전체 토론)' }}
        </span>
      {% endif %}
    </div>

    {% set stage_colors = [
      ('#eff6ff', '#3b82f6', '#2563eb'),
      ('#fff7ed', '#f97316', '#ea580c'),
      ('#fdf4ff', '#a855f7', '#9333ea'),
      ('#f0fdfa', '#14b8a6', '#0f766e'),
      ('#fff1f2', '#f43f5e', '#be123c'),
      ('#fffbeb', '#f59e0b', '#b45309'),
    ] %}
    {% if result.get('stages') and result.get('decision') != 'SIMPLE' %}
      {% for stage in result.stages %}
        {% set ci = loop.index0 % stage_colors|length %}
        {% set bg, border, label_color = stage_colors[ci] %}
        <div class="stage" style="background: {{ bg }}; border-left: 4px solid {{ border }};">
          <div class="stage-label" style="color: {{ label_color }};">{{ stage.name }}</div>
          <div class="stage-content">{{ stage.text }}</div>
        </div>
      {% endfor %}
    {% endif %}

    <div class="stage stage-final" style="{% if result.get('decision') == 'SIMPLE' %}margin-top: 0;{% endif %}">
      <div class="stage-label">최종 답변</div>
      <div class="stage-content">{{ result.final }}</div>
    </div>

    {% if result.get('quality') %}
      <div class="card" style="margin-top:12px; background:#f8fafc;">
        <div style="font-weight:700; margin-bottom:8px;">품질 매트릭</div>
        <div class="text-muted" style="font-size:13px;">
          정확성 {{ result.quality.accuracy }} · 완성도 {{ result.quality.completeness }} · 일관성 {{ result.quality.consistency }} · 형식 {{ result.quality.format }} · 종합 {{ result.quality.overall }}
          {% if result.quality.refined %}<span style="margin-left:6px; color:#2563eb;">(자동 보정 적용)</span>{% endif %}
        </div>
      </div>
    {% endif %}

    {% if result.get('monitoring') %}
      <div class="card" style="margin-top:12px; background:#f8fafc;">
        <div style="font-weight:700; margin-bottom:8px;">실행 모니터링</div>
        <div class="text-muted" style="font-size:13px; margin-bottom:8px;">
          총 지연시간 {{ result.monitoring.total_latency_ms }}ms
          · 입력 {{ result.monitoring.total_input_tokens }}tok
          · 출력 {{ result.monitoring.total_output_tokens }}tok
          · 비용 ${{ result.monitoring.total_cost_usd }}
          {% if result.monitoring.budget_guard_triggered %} · 예산 가드 발동{% endif %}
        </div>
        {% if result.monitoring.stage_metrics %}
          <div style="display:flex; flex-direction:column; gap:4px; font-size:12px;">
            {% for name, m in result.monitoring.stage_metrics.items() %}
              <div>
                <span class="mono">{{ name }}</span>:
                {{ m.latency_ms }}ms / retry {{ m.retries }} / {{ m.status }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div style="margin-top: 16px; text-align: right;">
      <a href="/conversations" style="font-size: 13px; color: #6366f1; font-weight: 500;">
        전체 대화 기록 보기 →
      </a>
    </div>
  </div>
{% endif %}

<script>
  document.getElementById('ask-form').addEventListener('submit', function() {
    document.getElementById('btn-text').textContent = '토론 중...';
    document.getElementById('ask-btn').disabled = true;
    document.getElementById('loading-msg').style.display = 'inline';
  });
  // Ctrl+Enter or Cmd+Enter to submit
  document.getElementById('question').addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      document.getElementById('ask-form').requestSubmit();
    }
  });
</script>

{% endblock %}
