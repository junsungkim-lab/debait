{% extends "base.html" %}
{% block content %}

<div style="margin-bottom: 24px;">
  <h1 style="font-size: 20px; font-weight: 800; color: #0f172a;">Settings</h1>
  <p class="text-muted mt-2">API Key Â· ëª¨ë¸ Â· Telegram ì—°ê²°ì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
</div>

<!-- API Keys -->
<div class="card">
  <h2>API Key ë“±ë¡</h2>
  <p class="text-muted" style="margin-bottom: 16px; font-size: 14px;">
    í‚¤ëŠ” ì„œë²„ì˜ MASTER_KEYë¡œ ì•”í˜¸í™” ì €ì¥ë©ë‹ˆë‹¤. í‰ë¬¸ ì €ì¥ ì—†ìŒ.
  </p>

  <!-- ë“±ë¡ í˜„í™© -->
  <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
    {% for provider, label in [('openai','OpenAI'), ('anthropic','Anthropic'), ('google','Google'), ('groq','Groq'), ('mistral','Mistral')] %}
      <span style="padding: 5px 14px; border-radius: 99px; font-size: 13px; font-weight: 600;
        background: {{ '#dcfce7' if keys.get(provider) else '#f1f5f9' }};
        color: {{ '#15803d' if keys.get(provider) else '#94a3b8' }};">
        {{ label }} {{ 'âœ“' if keys.get(provider) else 'ë¯¸ë“±ë¡' }}
      </span>
    {% endfor %}
  </div>

  <form method="post" action="/keys">
    <div class="row">
      <div>
        <label>Provider</label>
        <select name="provider" id="provider-select" onchange="updateKeyHint()">
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic</option>
          <option value="google">Google (Gemini)</option>
          <option value="groq">Groq</option>
          <option value="mistral">Mistral</option>
        </select>
      </div>
      <div>
        <label>API Key</label>
        <input type="text" name="api_key" id="api-key-input" placeholder="sk-..." required/>
        <div id="key-hint" class="text-muted mt-2" style="font-size: 12px;"></div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-4">ì €ì¥</button>
  </form>
</div>

<!-- Model Reference -->
<div class="card">
  <h2>ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡</h2>
  <p class="text-muted" style="margin-bottom: 16px; font-size: 14px;">
    ì•„ë˜ ëª¨ë¸ IDë¥¼ ë³µì‚¬í•´ì„œ ëª¨ë¸ ì„¤ì •ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
  </p>

  <div style="display: flex; flex-direction: column; gap: 12px;">
    {% set providers_info = [
      ('ğŸŸ¢', 'OpenAI', '#dcfce7', '#15803d', [
        ('openai:gpt-4o-mini', 'ì €ë ´ Â· ë¹ ë¦„'),
        ('openai:gpt-4o', 'ê³ í’ˆì§ˆ'),
      ]),
      ('ğŸŸ ', 'Anthropic', '#fff7ed', '#c2410c', [
        ('anthropic:claude-haiku-4-5-20251001', 'ì €ë ´ Â· ë¹ ë¦„'),
        ('anthropic:claude-sonnet-4-6', 'ê³ í’ˆì§ˆ'),
      ]),
      ('ğŸ”µ', 'Google Gemini', '#eff6ff', '#1d4ed8', [
        ('google:gemini-2.0-flash', 'ì €ë ´ Â· ë¹ ë¦„'),
        ('google:gemini-2.5-pro-preview-05-06', 'ê³ í’ˆì§ˆ'),
      ]),
      ('ğŸŸ£', 'Groq', '#fdf4ff', '#7e22ce', [
        ('groq:llama-3.3-70b-versatile', 'ë¹ ë¦„ Â· ë¬´ë£Œ í‹°ì–´'),
        ('groq:llama-3.1-8b-instant', 'ì´ˆê³ ì† Â· ì €ë ´'),
      ]),
      ('ğŸ”´', 'Mistral', '#fff1f2', '#be123c', [
        ('mistral:mistral-small-latest', 'ì €ë ´'),
        ('mistral:mistral-medium-latest', 'ê³ í’ˆì§ˆ'),
      ]),
    ] %}

    {% for icon, name, bg, color, models in providers_info %}
      <div style="background: {{ bg }}; border-radius: 10px; padding: 14px 16px;">
        <div style="font-weight: 700; color: {{ color }}; font-size: 13px; margin-bottom: 8px;">
          {{ icon }} {{ name }}
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          {% for model_id, desc in models %}
            <div style="display: flex; align-items: center; gap: 6px;">
              <code class="mono" style="background: rgba(0,0,0,0.07); padding: 3px 8px; border-radius: 6px; font-size: 12px; cursor: pointer;"
                onclick="copyModel('{{ model_id }}')">{{ model_id }}</code>
              <span class="text-muted" style="font-size: 11px;">{{ desc }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
  <div class="text-muted mt-3" style="font-size: 12px;">ğŸ’¡ ëª¨ë¸ IDë¥¼ í´ë¦­í•˜ë©´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤.</div>
</div>

<!-- Pipeline Editor -->
<div class="card" id="pipeline">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
    <h2 style="margin-bottom:0;">í† ë¡  íŒŒì´í”„ë¼ì¸</h2>
    <span id="stage-count-badge" style="font-size:12px; font-weight:700; padding:3px 10px; border-radius:99px; background:#ede9fe; color:#6d28d9;">
      {{ stages|length }} / {{ max_stages }}
    </span>
  </div>
  <p class="text-muted" style="margin-bottom:20px; font-size:14px;">
    ìŠ¤í…Œì´ì§€ë¥¼ ì¶”ê°€Â·ì‚­ì œÂ·ìˆœì„œë³€ê²½í•˜ì„¸ìš”. ë§ˆì§€ë§‰ì—” í•­ìƒ <strong>Synth</strong>ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ìµœëŒ€ {{ max_stages }}ê°œ.
  </p>

  <form method="post" action="/pipeline" id="pipeline-form">

    <!-- ìŠ¤í…Œì´ì§€ ëª©ë¡ -->
    <div id="stage-list" style="display:flex; flex-direction:column; gap:12px; margin-bottom:20px;">
      {% for s in stages %}
      <div class="stage-row" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <span style="cursor:grab; color:#94a3b8; font-size:18px;" class="drag-handle">â ¿</span>
          <input type="text" name="stage_name" value="{{ s.name }}"
            placeholder="ìŠ¤í…Œì´ì§€ ì´ë¦„" required
            style="font-weight:700; font-size:14px; max-width:180px;"/>
          <input type="text" name="stage_model" value="{{ s.model }}" class="mono"
            placeholder="provider:model"
            style="flex:1; font-size:13px;"/>
          <button type="button" class="btn btn-secondary" style="padding:6px 10px; flex-shrink:0;"
            onclick="moveUp(this)">â†‘</button>
          <button type="button" class="btn btn-secondary" style="padding:6px 10px; flex-shrink:0;"
            onclick="moveDown(this)">â†“</button>
          <button type="button" class="btn" style="padding:6px 10px; flex-shrink:0; background:#fef2f2; color:#dc2626; border:1px solid #fca5a5;"
            onclick="removeStage(this)">âœ•</button>
        </div>
        <textarea name="stage_prompt" rows="3"
          style="font-size:13px; font-family:inherit; resize:vertical;">{{ s.system_prompt }}</textarea>
      </div>
      {% endfor %}
    </div>

    <!-- Synth (í•­ìƒ ë§ˆì§€ë§‰, ê³ ì •) -->
    <div style="background:#f0fdf4; border:2px solid #22c55e; border-radius:12px; padding:16px; margin-bottom:20px;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:800; color:#16a34a;">âš¡ Synth</span>
        <span class="text-muted" style="font-size:12px;">í•­ìƒ ë§ˆì§€ë§‰ Â· ëª¨ë“  ë‹¨ê³„ë¥¼ ì¢…í•©í•´ ìµœì¢… ë‹µë³€ ìƒì„±</span>
        <input type="text" name="synth_model" value="{{ synth_model }}" class="mono"
          placeholder="provider:model"
          style="flex:1; font-size:13px; margin-left:auto;"/>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button type="button" class="btn btn-secondary" id="add-btn" onclick="addStage()">
        + ìŠ¤í…Œì´ì§€ ì¶”ê°€
      </button>
      <button type="submit" class="btn btn-primary">ì €ì¥</button>
      <span id="limit-msg" class="text-muted" style="font-size:13px; display:none;">
        ìµœëŒ€ {{ max_stages }}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </span>
    </div>
  </form>

  <form method="post" action="/pipeline/reset" style="margin-top:12px;"
    onsubmit="return confirm('íŒŒì´í”„ë¼ì¸ì„ ê¸°ë³¸ê°’(Solver â†’ Critic â†’ Checker)ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')">
    <button type="submit" class="btn btn-secondary" style="font-size:13px; color:#64748b;">
      ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
    </button>
  </form>
</div>

<!-- Telegram -->
<div class="card">
  <h2>Telegram ì—°ê²°</h2>
  <p class="text-muted" style="margin-bottom: 16px; font-size: 14px;">
    Telegram ë´‡ê³¼ ì—°ê²°í•˜ë©´ ì±„íŒ…ì—ì„œë„ AI í† ë¡ ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  </p>
  <div class="row">
    <div>
      <label>ì—°ê²° ì½”ë“œ <span class="text-muted">(5ë¶„ ìœ íš¨)</span></label>
      <input type="text" value="{{ link_code }}" readonly class="mono"/>
      <div class="text-muted mt-2">Telegram ë´‡ì—ê²Œ ì´ ì½”ë“œë¥¼ ì „ì†¡í•˜ì„¸ìš”. ë§Œë£Œë˜ë©´ ìƒˆë¡œê³ ì¹¨.</div>
    </div>
    <div>
      <label>Webhook URL</label>
      <input type="text" value="{{ webhook_url }}" readonly class="mono"/>
      <div class="text-muted mt-2"><code>scripts/set_webhook.py</code>ë¡œ ì„¤ì •í•˜ì„¸ìš”.</div>
    </div>
  </div>
</div>

<script>
  const hints = {
    openai:    { placeholder: 'sk-...', hint: 'ë°œê¸‰: platform.openai.com/api-keys' },
    anthropic: { placeholder: 'sk-ant-...', hint: 'ë°œê¸‰: console.anthropic.com/settings/keys' },
    google:    { placeholder: 'AIza...', hint: 'ë°œê¸‰: aistudio.google.com/apikey' },
    groq:      { placeholder: 'gsk_...', hint: 'ë°œê¸‰: console.groq.com/keys Â· ë¬´ë£Œ í‹°ì–´ ìˆìŒ' },
    mistral:   { placeholder: 'mist_...', hint: 'ë°œê¸‰: console.mistral.ai/api-keys' },
  };
  function updateKeyHint() {
    const p = document.getElementById('provider-select').value;
    const info = hints[p] || {};
    document.getElementById('api-key-input').placeholder = info.placeholder || '';
    document.getElementById('key-hint').textContent = info.hint || '';
  }
  function copyModel(id) {
    navigator.clipboard.writeText(id).then(() => {
      const els = document.querySelectorAll('code');
      els.forEach(el => { if (el.textContent === id) { el.style.background = 'rgba(99,102,241,0.2)'; setTimeout(() => el.style.background = '', 800); } });
    });
  }
  updateKeyHint();

  // â”€â”€ Pipeline editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const MAX_STAGES = {{ max_stages }};

  function countStages() {
    return document.querySelectorAll('#stage-list .stage-row').length;
  }

  function updateUI() {
    const n = countStages();
    document.getElementById('stage-count-badge').textContent = `${n} / ${MAX_STAGES}`;
    const atMax = n >= MAX_STAGES;
    document.getElementById('add-btn').disabled = atMax;
    document.getElementById('limit-msg').style.display = atMax ? 'inline' : 'none';
  }

  function addStage() {
    if (countStages() >= MAX_STAGES) return;
    const list = document.getElementById('stage-list');
    const div = document.createElement('div');
    div.className = 'stage-row';
    div.style.cssText = 'background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:16px;';
    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
        <span style="cursor:grab; color:#94a3b8; font-size:18px;" class="drag-handle">â ¿</span>
        <input type="text" name="stage_name" placeholder="ìŠ¤í…Œì´ì§€ ì´ë¦„" required
          style="font-weight:700; font-size:14px; max-width:180px; padding:10px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; width:100%; outline:none;"/>
        <input type="text" name="stage_model" class="mono" placeholder="provider:model"
          style="flex:1; font-size:13px; padding:10px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; outline:none;"/>
        <button type="button" class="btn btn-secondary" style="padding:6px 10px; flex-shrink:0;" onclick="moveUp(this)">â†‘</button>
        <button type="button" class="btn btn-secondary" style="padding:6px 10px; flex-shrink:0;" onclick="moveDown(this)">â†“</button>
        <button type="button" class="btn" style="padding:6px 10px; flex-shrink:0; background:#fef2f2; color:#dc2626; border:1px solid #fca5a5;" onclick="removeStage(this)">âœ•</button>
      </div>
      <textarea name="stage_prompt" rows="3" placeholder="ì´ ìŠ¤í…Œì´ì§€ì˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        style="width:100%; font-size:13px; font-family:inherit; padding:10px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; resize:vertical; outline:none;"></textarea>
    `;
    list.appendChild(div);
    updateUI();
    div.querySelector('input[name="stage_name"]').focus();
  }

  function removeStage(btn) {
    btn.closest('.stage-row').remove();
    updateUI();
  }

  function moveUp(btn) {
    const row = btn.closest('.stage-row');
    const prev = row.previousElementSibling;
    if (prev) row.parentNode.insertBefore(row, prev);
  }

  function moveDown(btn) {
    const row = btn.closest('.stage-row');
    const next = row.nextElementSibling;
    if (next) row.parentNode.insertBefore(next, row);
  }

  updateUI();
</script>

{% endblock %}
